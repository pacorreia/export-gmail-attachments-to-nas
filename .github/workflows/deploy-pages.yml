name: Deploy GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - '.github/pages/**'
      - '.github/workflows/deploy-pages.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests and generate coverage
        run: |
          pytest tests/ -v --cov=export_gmail_attachments_to_nas --cov-report=xml --cov-report=term
      
      - name: Build site with coverage badge
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import re
          import shutil
          import os
          
          # Parse coverage.xml to extract line coverage percentage
          tree = ET.parse('./coverage.xml')
          root = tree.getroot()
          
          line_rate = float(root.get('line-rate', 0))
          coverage_percent = int(line_rate * 100)
          
          # Determine badge color
          if coverage_percent >= 80:
              color = 'success'
          elif coverage_percent >= 60:
              color = 'yellow'
          else:
              color = 'critical'
          
          # Create build directory
          os.makedirs('build', exist_ok=True)
          
          # Read the HTML template
          with open('.github/pages/index.html', 'r') as f:
              content = f.read()
          
          # Update the badge URL with actual coverage
          new_badge = f'https://img.shields.io/badge/Code%20Coverage-{coverage_percent}%25-{color}?style=flat'
          content = re.sub(
              r'https://img\.shields\.io/badge/Code%20Coverage-\d+%25-\w+\?style=flat',
              new_badge,
              content
          )
          
          # Write to build directory
          with open('build/index.html', 'w') as f:
              f.write(content)
          
          # Copy CSS file
          shutil.copy('.github/pages/style.css', 'build/style.css')
          
          print(f"Site built with coverage: {coverage_percent}%")
          EOF
      
      - name: Deploy to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fetch gh-pages branch
          git fetch origin gh-pages 2>/dev/null || true
          
          # Create or checkout gh-pages branch
          if git rev-parse --verify origin/gh-pages > /dev/null 2>&1; then
            git checkout gh-pages
            git reset --hard origin/gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi
          
          # Copy built files
          cp -r build/* .
          rm -rf build
          
          # Stage and commit changes
          git add index.html style.css
          if git diff --staged --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy: Update GitHub Pages"
            git push origin gh-pages
          fi